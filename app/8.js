import{N as S}from"./-.js";import{c as f}from"./d.js";import{i as k}from"./..js";import{H}from"./c.js";import"./q.js";import"./$.js";import"./f.js";import"./x.js";var t,N,o=S(!0);({recbar:t}=k);o.stop=t.cancel;N=new Promise(s=>{o.start=s});var q=async(s,h)=>{var y,b,P,p,r,m,a,n,_;a=new MediaRecorder(s,{mimeType:"video/webm;codecs=vp9",videoBitsPerSecond:2e7}),await N,typeof h=="function"&&h(),o.pause=e=>{var c,i,l,v,T,w,u,g,d;for(w=0,d=[],u=s.getTracks(),l=0,T=u.length;l<T;l++)i=u[l],e?c=!1:({kind:v}=i,v==="video"&&d.push(i),c=!!f[v],c&&(w+=1)),i.enabled=c;if(w===0&&e===!1){if(f.src==="camera")if(d.length){f.video=localStorage.video;for(i of d)i.enabled=!0}else broadcast.pause(!0);return}({state:g}=a),g.startsWith("pause")?e||a.resume():g==="recording"&&e&&a.pause()},n=new Map,[_,b,y]=await E.upload("rec/"+f.src),r=0,a.ondataavailable=({data:e})=>{n.set(r,(async()=>{await _(r,e),n.delete(r)})()),++r},p=void 0,P=new Promise(e=>{p=e}),m=()=>{try{a.stop()}catch{}},o.cancel=async()=>{m(),await y(),t.cancel()},o.stop=async()=>{m(),t.stop(),await P,await k.open(H+`video_details.html?user_token=${localStorage.uid}&id=`+await b()),await t.end()},a.onstop=async()=>{await Promise.all(n.values()),p()},a.start(5e3)};export{o as ON,q as default};
