import{N as x}from"./$.js";import{s as H}from"./l.js";import{c as p}from"./0.js";import{i as N}from"./-.js";import{H as M}from"./4.js";import"./_.js";import"./.js";import"./z.js";import"./y.js";var S,m,c,$,i=x(!0);({recbar:c,camera:S}=N);i.stop=c.cancel;m=()=>p.src==="camera";$=new Promise(t=>{i.start=t});var D=async(t,b)=>{var v,_,P,u,s,n,r,l,T;r=new MediaRecorder(t,{mimeType:"video/webm;codecs=vp9",videoBitsPerSecond:2048e3}),await $,typeof b=="function"&&b(),i.pause=e=>{var a,o,d,w,k,g,y,h,f;if(m()){for(g=0,f=[],y=t.getTracks(),d=0,k=y.length;d<k;d++)o=y[d],e?a=!1:({kind:w}=o,w==="video"&&f.push(o),a=!!p[w],a&&(g+=1)),o.enabled=a;if(g===0&&e===!1)if(f.length){p.video=localStorage.video;for(o of f)o.enabled=!0}else{broadcast.pause(!0);return}}({state:h}=r),h.startsWith("pause")?e||r.resume():h==="recording"&&e&&r.pause()},l=new Map,[T,_,v]=await E.upload("rec/"+p.src),s=0,r.ondataavailable=({data:e})=>{l.set(s,(async()=>{await T(s,e),l.delete(s)})()),++s},u=void 0,P=new Promise(e=>{u=e}),n=()=>{var e;try{r.stop()}catch(a){e=a,console.error(e)}},i.cancel=async()=>{n(),await v(),c.cancel()},i.reset=()=>{n(),v().finally(async()=>{if(H(),m())return await S.x_rect()})},i.stop=async()=>{n(),c.stop(m()),gc(),await P,t.getTracks().map(e=>{e.stop()}),gc(),await N.open(M+`video_details.html?user_token=${localStorage.uid}&id=`+await _()),await c.end()},r.onstop=async()=>{await Promise.all(l.values()),u()},r.onerror=e=>{console.error(`record \u274C ${e.error.name}`)},r.start(5e3)};export{i as ON,D as default};
