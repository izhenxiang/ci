import{N as S}from"./1.js";import{c as g}from"./-.js";import{i as k}from"./3.js";import{H}from"./e.js";import"./s.js";import"./0.js";import"./g.js";import"./$.js";var t,N,o=S(!0);({recbar:t}=k);o.stop=t.cancel;N=new Promise(s=>{o.start=s});var q=async(s,h)=>{var y,b,P,f,r,p,a,n,_;a=new MediaRecorder(s,{mimeType:"video/webm;codecs=vp9",videoBitsPerSecond:512e4}),await N,typeof h=="function"&&h(),o.pause=e=>{var c,i,l,m,T,v,w,u,d;for(v=0,d=[],w=s.getTracks(),l=0,T=w.length;l<T;l++)i=w[l],e?c=!1:({kind:m}=i,m==="video"&&d.push(i),c=!!g[m],c&&(v+=1)),i.enabled=c;if(v===0&&e===!1){if(d.length){g.video=localStorage.video;for(i of d)i.enabled=!0}else broadcast.pause(!0);return}({state:u}=a),u.startsWith("pause")?e||a.resume():u==="recording"&&e&&a.pause()},n=new Map,[_,b,y]=await E.upload("rec/"+g.src),r=0,a.ondataavailable=({data:e})=>{n.set(r,(async()=>{await _(r,e),n.delete(r)})()),++r},f=void 0,P=new Promise(e=>{f=e}),p=()=>{try{a.stop()}catch{}},o.cancel=async()=>{p(),await y(),t.cancel()},o.stop=async()=>{p(),t.stop(),await P,await k.open(H+`video_details.html?user_token=${localStorage.uid}&id=`+await b()),await t.end()},a.onstop=async()=>{await Promise.all(n.values()),f()},a.start(5e3)};export{o as ON,q as default};
