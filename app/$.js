import{N as H}from"./0.js";import{s as M}from"./b.js";import{c as f}from"./6.js";import{i as N}from"./1.js";import{H as $}from"./5.js";import"./a.js";import"./-.js";import"./z.js";import"./x.js";var y,s,S,i=H(!0);({recbar:s}=N);i.stop=s.cancel;y=()=>f.src==="camera";S=new Promise(t=>{i.start=t});var C=async(t,b)=>{var p,_,P,m,o,v,a,c,T;a=new MediaRecorder(t,{mimeType:"video/webm;codecs=h264",videoBitsPerSecond:2048e3}),await S,typeof b=="function"&&b(),i.pause=e=>{var n,r,l,u,k,w,g,h,d;if(y()){for(w=0,d=[],g=t.getTracks(),l=0,k=g.length;l<k;l++)r=g[l],e?n=!1:({kind:u}=r,u==="video"&&d.push(r),n=!!f[u],n&&(w+=1)),r.enabled=n;if(w===0&&e===!1)if(d.length){f.video=localStorage.video;for(r of d)r.enabled=!0}else{broadcast.pause(!0);return}}({state:h}=a),h.startsWith("pause")?e||a.resume():h==="recording"&&e&&a.pause()},c=new Map,[T,_,p]=await E.upload("rec/"+f.src),o=0,a.ondataavailable=({data:e})=>{c.set(o,(async()=>{await T(o,e),c.delete(o)})()),++o},m=void 0,P=new Promise(e=>{m=e}),v=()=>{try{a.stop()}catch{}},i.cancel=async()=>{v(),await p(),s.cancel()},i.reset=()=>{p().finally(M)},i.stop=async()=>{v(),s.stop(y()),gc(),await P,t.getTracks().map(e=>{e.stop()}),gc(),await N.open($+`video_details.html?user_token=${localStorage.uid}&id=`+await _()),await s.end()},a.onstop=async()=>{await Promise.all(c.values()),m()},a.start(5e3)};export{i as ON,C as default};
