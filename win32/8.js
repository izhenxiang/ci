import{N as M}from"./1.js";import{s as S}from"./6.js";import{c as d}from"./.js";import{i as N}from"./3.js";import{H as $}from"./a.js";import"./n.js";import"./..js";import"./z.js";import"./s.js";var x,m,s,H,t=M(!0);({recbar:s,camera:x}=N);t.stop=s.cancel;m=()=>d.src==="camera";H=new Promise(i=>{t.start=i});var D=async(i,b)=>{var u,_,T,v,o,c,a,n,k;a=new MediaRecorder(i,{mimeType:"video/webm;codecs=vp9"}),await H,typeof b=="function"&&b(),t.pause=e=>{var l,r,f,w,P,g,y,h,p;if(m()){for(g=0,p=[],y=i.getTracks(),f=0,P=y.length;f<P;f++)r=y[f],e?l=!1:({kind:w}=r,w==="video"&&p.push(r),l=!!d[w],l&&(g+=1)),r.enabled=l;if(g===0&&e===!1)if(p.length){d.video=localStorage.video;for(r of p)r.enabled=!0}else{broadcast.pause(!0);return}}({state:h}=a),h.startsWith("pause")?e||a.resume():h==="recording"&&e&&a.pause()},n=new Map,[k,_,u]=await E.upload("rec/"+d.src),o=0,a.ondataavailable=({data:e})=>{n.set(o,(async()=>{await k(o,e),n.delete(o)})()),++o},v=void 0,T=new Promise(e=>{v=e}),c=()=>{try{a.stop()}catch{}},t.cancel=async()=>{c(),await u(),s.cancel()},t.reset=()=>{c(),u().finally(async()=>{if(S(),m())return await x.x_rect()})},t.stop=async()=>{c(),s.stop(m()),gc(),await T,i.getTracks().map(e=>{e.stop()}),gc(),await N.open($+`video_details.html?user_token=${localStorage.uid}&id=`+await _()),await s.end()},a.onstop=async()=>{await Promise.all(n.values()),v()},a.start(5e3)};export{t as ON,D as default};
