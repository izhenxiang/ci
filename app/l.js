import{N as H}from"./-.js";import{s as M}from"./b.js";import{c as p}from"./6.js";import{i as N}from"./..js";import{H as $}from"./5.js";import"./a.js";import"./$.js";import"./z.js";import"./w.js";var y,s,S,i=H(!0);({recbar:s}=N);i.stop=s.cancel;y=()=>p.src==="camera";S=new Promise(t=>{i.start=t});var C=async(t,b)=>{var m,_,P,v,o,c,a,n,T;a=new MediaRecorder(t,{mimeType:"video/webm;codecs=h264",videoBitsPerSecond:2048e3}),await S,typeof b=="function"&&b(),i.pause=e=>{var l,r,d,u,k,w,g,h,f;if(y()){for(w=0,f=[],g=t.getTracks(),d=0,k=g.length;d<k;d++)r=g[d],e?l=!1:({kind:u}=r,u==="video"&&f.push(r),l=!!p[u],l&&(w+=1)),r.enabled=l;if(w===0&&e===!1)if(f.length){p.video=localStorage.video;for(r of f)r.enabled=!0}else{broadcast.pause(!0);return}}({state:h}=a),h.startsWith("pause")?e||a.resume():h==="recording"&&e&&a.pause()},n=new Map,[T,_,m]=await E.upload("rec/"+p.src),o=0,a.ondataavailable=({data:e})=>{n.set(o,(async()=>{await T(o,e),n.delete(o)})()),++o},v=void 0,P=new Promise(e=>{v=e}),c=()=>{try{a.stop()}catch{}},i.cancel=async()=>{c(),await m(),s.cancel()},i.reset=()=>{c(),m().finally(M)},i.stop=async()=>{c(),s.stop(y()),gc(),await P,t.getTracks().map(e=>{e.stop()}),gc(),await N.open($+`video_details.html?user_token=${localStorage.uid}&id=`+await _()),await s.end()},a.onstop=async()=>{await Promise.all(n.values()),v()},a.start(5e3)};export{i as ON,C as default};
