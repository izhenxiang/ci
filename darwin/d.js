import{N as x}from"./-.js";import{s as H}from"./k.js";import{c as p}from"./2.js";import{i as S}from"./0.js";import{H as M}from"./4.js";import"./b.js";import"./$.js";import"./x.js";import"./w.js";var N,m,c,$,t=x(!0);({recbar:c,camera:N}=S);t.stop=c.cancel;m=()=>p.src==="camera";$=new Promise(i=>{t.start=i});var D=async(i,b)=>{var v,_,P,u,s,n,r,l,T;r=new MediaRecorder(i,{mimeType:"video/webm;codecs="+(localStorage.area?"h264":"vp9"),videoBitsPerSecond:2048e3}),await $,typeof b=="function"&&b(),t.pause=e=>{var a,o,d,w,k,g,y,h,f;if(m()){for(g=0,f=[],y=i.getTracks(),d=0,k=y.length;d<k;d++)o=y[d],e?a=!1:({kind:w}=o,w==="video"&&f.push(o),a=!!p[w],a&&(g+=1)),o.enabled=a;if(g===0&&e===!1)if(f.length){p.video=localStorage.video;for(o of f)o.enabled=!0}else{broadcast.pause(!0);return}}({state:h}=r),h.startsWith("pause")?e||r.resume():h==="recording"&&e&&r.pause()},l=new Map,[T,_,v]=await E.upload("rec/"+p.src),s=0,r.ondataavailable=({data:e})=>{l.set(s,(async()=>{await T(s,e),l.delete(s)})()),++s},u=void 0,P=new Promise(e=>{u=e}),n=()=>{var e;try{r.stop()}catch(a){e=a,console.error(e)}},t.cancel=async()=>{n(),await v(),c.cancel()},t.reset=()=>{n(),v().finally(async()=>{if(H(),m())return await N.x_rect()})},t.stop=async()=>{n(),c.stop(m()),gc(),await P,i.getTracks().map(e=>{e.stop()}),gc(),await S.open(M+`video_details.html?user_token=${localStorage.uid}&id=`+await _()),await c.end()},r.onstop=async()=>{await Promise.all(l.values()),u()},r.onerror=e=>{console.error(`record \u274C ${e.error.name}`)},r.start(5e3)};export{t as ON,D as default};
